name: Build Openlist Packages (openwrt-18.06)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: false
        default: 'latest'
  push:
    tags:
      - "*"

jobs:
  build-openlist-ipk:
    name: Build luci-app-openlist (openwrt-18.06)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========== 修改点 1：安装系统级 Go 环境（兼容 openwrt-18.06，选择 Go 1.19 稳定版） ==========
      - name: Install build dependencies (include Go environment)
        run: |
          sudo -E apt-get update
          sudo -E apt-get -y install gcc make wget upx  # 额外安装 upx（直接用于二进制压缩，无需依赖 Makefile）
          
          # 下载并安装 Go 1.19（兼容 openwrt-18.06，版本不宜过高）
          GO_VERSION="1.19.13"
          GO_ARCH="amd64"
          wget -O /tmp/go.tar.gz https://dl.google.com/go/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          
          # 配置 Go 环境变量
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          echo "GOPATH=$HOME/go" >> $GITHUB_ENV
          go version  # 验证 Go 安装成功

      # ========== 修改点 2：移除对 Makefile 的 sed 修改（不再依赖 SDK 的 golang-package.mk），直接定义 Go 编译参数 ==========
      - name: Define Go build parameters (replace Makefile sed)
        run: |
          # 提前创建编译输出目录，避免报错
          mkdir -p $GITHUB_WORKSPACE/openlist/bin
          echo "GO_BUILD_FLAGS='-ldflags=\"-w -s -extldflags=-static\"'" >> $GITHUB_ENV
          echo "UPX_FLAGS='--lzma --best'" >> $GITHUB_ENV

      # （删除原有的 "Configure Static Linking" 和 "Configure UPX Compression" 步骤，因为不再依赖 Makefile）

      - name: Create ipk package directory
        run: |
          IPK_DIR="/tmp/luci-app-openlist"
          mkdir -p \
            $IPK_DIR/usr/bin \
            $IPK_DIR/usr/lib/lua/luci \
            $IPK_DIR/www \
            $IPK_DIR/etc/init.d \
            $IPK_DIR/etc/uci-defaults \
            $IPK_DIR/CONTROL
          echo "IPK_DIR=$IPK_DIR" >> $GITHUB_ENV

      # ========== 修改点 3：替换 Makefile 编译，用系统 Go 直接编译 openlist，同时完成 UPX 压缩 ==========
      - name: Copy openlist source and build binary (system Go)
        run: |
          # 复制 luasrc、root、htdocs （这部分和之前一致，保留）
          if [ -d "$GITHUB_WORKSPACE/openlist/luasrc" ]; then
            cp -R $GITHUB_WORKSPACE/openlist/luasrc/* ${{ env.IPK_DIR }}/usr/lib/lua/luci/
            echo "Luasrc copied successfully."
          fi

          if [ -d "$GITHUB_WORKSPACE/openlist/root" ]; then
            cp -R $GITHUB_WORKSPACE/openlist/root/* ${{ env.IPK_DIR }}/
            chmod +x ${{ env.IPK_DIR }}/etc/init.d/* >/dev/null 2>&1
            chmod +x ${{ env.IPK_DIR }}/etc/uci-defaults/* >/dev/null 2>&1
            echo "Root files copied and permissions set."
          fi

          if [ -d "$GITHUB_WORKSPACE/openlist/htdocs" ]; then
            cp -R $GITHUB_WORKSPACE/openlist/htdocs/* ${{ env.IPK_DIR }}/www/
            echo "Htdocs copied successfully."
          fi

          # 关键：用系统 Go 直接编译 openlist（不再用 make）
          cd $GITHUB_WORKSPACE/openlist
          if [ -f "go.mod" ]; then
            go mod tidy  # 安装 Go 依赖
            go build ${{ env.GO_BUILD_FLAGS }} -o ./bin/openlist  # 静态链接编译
            echo "Openlist binary compiled with system Go successfully."
          else
            # 若没有 go.mod（传统 GOPATH 模式），直接编译主程序（假设主文件在当前目录）
            go build ${{ env.GO_BUILD_FLAGS }} -o ./bin/openlist
            echo "Openlist binary compiled (GOPATH mode) successfully."
          fi

          # 复制编译好的二进制文件到 ipk 目录
          cp ./bin/openlist ${{ env.IPK_DIR }}/usr/bin/
          chmod +x ${{ env.IPK_DIR }}/usr/bin/openlist

          # 完成 UPX 压缩（直接用系统 upx，排除不支持的架构，这里因为是通用编译，可直接压缩，若需排除可添加判断）
          if command -v upx &> /dev/null; then
            upx ${{ env.UPX_FLAGS }} ${{ env.IPK_DIR }}/usr/bin/openlist
            echo "Openlist binary compressed with UPX successfully."
          else
            echo "Warning: UPX not found, skip compression."
          fi

      - name: Build po2lmo and convert i18n files
        continue-on-error: true
        run: |
          PO2LMO_DIR="/tmp/po2lmo"
          mkdir -p $PO2LMO_DIR ${{ env.IPK_DIR }}/usr/lib/lua/luci/i18n/

          wget -O $PO2LMO_DIR/po2lmo.c https://raw.githubusercontent.com/openwrt/luci/openwrt-18.06/modules/luci-base/src/po2lmo.c
          wget -O $PO2LMO_DIR/Makefile https://raw.githubusercontent.com/openwrt/luci/openwrt-18.06/modules/luci-base/src/Makefile
          wget -O $PO2LMO_DIR/template_lmo.h https://raw.githubusercontent.com/openwrt/luci/openwrt-18.06/modules/luci-base/src/template_lmo.h
          wget -O $PO2LMO_DIR/template_lmo.c https://raw.githubusercontent.com/openwrt/luci/openwrt-18.06/modules/luci-base/src/template_lmo.c

          cd $PO2LMO_DIR
          make po2lmo

          if [ -d "$GITHUB_WORKSPACE/openlist/po" ]; then
            ./po2lmo $GITHUB_WORKSPACE/openlist/po/zh-cn/openlist.po ${{ env.IPK_DIR }}/usr/lib/lua/luci/i18n/openlist.zh-cn.lmo
            echo "I18n file converted successfully."
          fi

      - name: Generate CONTROL files
        run: |
          TAG=${{ github.event.inputs.tag || github.ref_name || 'v1.0.0' }}
          echo "Current release tag: $TAG"

          cat >${{ env.IPK_DIR }}/CONTROL/control <<EOF
          Package: luci-app-openlist
          Version: $TAG
          Depends: luci-base, luci-lib-jsonc
          Architecture: all
          Maintainer: Your Name <your-email@example.com>
          Section: luci
          Priority: optional
          Description: Openlist for OpenWrt (openwrt-18.06)
          Source: http://github.com/your-repo/luci-app-openlist
          EOF

          cat >${{ env.IPK_DIR }}/CONTROL/postinst <<EOF
          #!/bin/sh
          if [ -z "\${IPKG_INSTROOT}" ]; then
            ( . /etc/uci-defaults/luci-app-openlist ) && rm -f /etc/uci-defaults/luci-app-openlist
          fi
          exit 0
          EOF

          chmod +x ${{ env.IPK_DIR }}/CONTROL/postinst
          echo "CONTROL files generated successfully."

      - name: Build final ipk package
        run: |
          wget -O /tmp/ipkg-build https://raw.githubusercontent.com/openwrt/openwrt/openwrt-18.06/scripts/ipkg-build
          chmod +x /tmp/ipkg-build

          TAG=${{ github.event.inputs.tag || github.ref_name || 'v1.0.0' }}
          /tmp/ipkg-build -o root -g root ${{ env.IPK_DIR }} /tmp

          IPK_FILE="/tmp/luci-app-openlist_${TAG}_all.ipk"
          mv /tmp/luci-app-openlist_*_all.ipk $IPK_FILE
          echo "Final ipk package created: $IPK_FILE"
          echo "IPK_FILE=$IPK_FILE" >> $GITHUB_ENV

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          release_name: Release ${{ github.event.inputs.tag || github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.IPK_FILE }}
          asset_name: luci-app-openlist_${{ github.event.inputs.tag || github.ref_name }}_all.ipk
          asset_content_type: application/octet-stream